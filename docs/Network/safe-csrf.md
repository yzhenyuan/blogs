# 跨站点请求伪造 csrf

跨站点请求伪造，指利用用户身份操作用户账户的一种攻击方式，即攻击者诱使用户访问一个页面，就以该用户身份在第三方有害站点中执行了一次操作，泄露了用户的身份信息，接着攻击者就可以使用这个伪造的，但真实存在的身份信息，到某网站冒充用户执行恶意操作。

但是，攻击者只有预测到URL的所有参数与参数值，才能成功地伪造一个请求（当然了，他可以在安全站点里以自己的身份实际去操作一下，还是能拿到参数的）；反之，攻击者无法攻击成功


### 一个典型的CSRF攻击有着如下的流程
+ 受害者登录a.com，并保留了登录凭证（Cookie）。
+ 攻击者引诱受害者访问了b.com。
+ b.com 向 a.com 发送了一个请求：a.com/act=xx。浏览器会默认携带a.com的Cookie。
+ a.com接收到请求后，对请求进行验证，并确认是受害者的凭证，误以为是受害者自己发送的请求。
+ a.com以受害者的名义执行了act=xx。
+ 攻击完成，攻击者在受害者不知情的情况下，冒充受害者，让a.com执行了自己定义的操作。

#### 完成一次CSRF攻击，必须满足两个条件

1. 用户登录受信任网站A，并且在本地生成Cookie
2. 在不登出网站A的情况下，访问有害网站B



## 一、CSRF的原理
CSRF攻击是攻击者利用**`用户身份`**操作用户账户的一种攻击方式

## 二、CSRF的攻击方式

### 2.1 浏览器的Cookie策略
浏览器所持有的策略一般分为两种：
+ Session Cookie，临时Cookie。保存在浏览器进程的内存中，浏览器关闭了即失效。
+ Third-party Cookie，本地Cookie。服务器在Set-Cookie时指定了Expire Time。过期了本地Cookie失效，则网站会要求用户重新登录。

在浏览网站的过程中，即使浏览器打开了Tab页，Session Cookie都是有效的，因此发起CSRF攻击是可行的。

### 2.2 P3P头的副作用
"P3P Header"是 "W3C" 制定的一项关于隐私的标准，全称是 "The Platform for Privacy Preference"（隐私偏好平台）

如果网站返回给浏览器的 HTTP 头包含有 P3P 头，则在某种程度上来说，将允许 浏览器发送第三方 Cookie。在 IE 下即使是"`<iframe>`、`<script>`等标签页将不再拦截第三方 Cookie 的发送。主要应用在类似广告等需要跨域访问的页面。

### 2.3 GET，POST请求
这里有个误区
大多数 CSRF 攻击，都是通过 
`<img> 、 <iframe> 、 <script> 等带 src 属性的标签，这类标签只能发送一次 GET 请求，而不能发送 POST 请求，由此也有了认为 CSRF 攻击只能由 GET 请求发起的错误观点`。

构造一个 POST 请求，只需要在一个不可见的iframe窗口中，构造一个form表单，然后使用JavaScript自动提交这个表单。那么整个自动提交表单的过程，对于用户来说就是不可见的。

## 三、CSRF的防御方式
CSRF通常从第三方网站发起，被攻击的网站无法防止攻击发生，只能通过增强自己网站针对CSRF的防护能力来提升安全性。

#### 上文中讲了CSRF的两个特点：

+ CSRF（通常）发生在第三方域名。
+ CSRF攻击者不能获取到Cookie等信息，只是使用。

#### 针对这两点，我们可以专门制定防护策略，如下：

+ 阻止不明外域的访问
+ 同源检测：既然CSRF大多来自第三方网站，那么我们就直接禁止外域（或者不受信任的域名）对我们发起请求。
+ Samesite Cookie
+ 提交时要求附加本域才能获取的信息
+ CSRF Token
+ 双重Cookie验证

[参考](https://tech.meituan.com/2018/10/11/fe-security-csrf.html)